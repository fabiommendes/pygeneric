<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>generic.conversion &mdash; pygeneric 0.5.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.5.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="pygeneric 0.5.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for generic.conversion</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Conversion and promotion between types.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ABCMeta</span>
<span class="kn">from</span> <span class="nn">.errors</span> <span class="kn">import</span> <span class="n">InexactError</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># Conversions</span>
    <span class="s">&#39;convert&#39;</span><span class="p">,</span> <span class="s">&#39;get_conversion&#39;</span><span class="p">,</span> <span class="s">&#39;set_conversion&#39;</span><span class="p">,</span>

    <span class="c"># Promotions</span>
    <span class="s">&#39;promote&#39;</span><span class="p">,</span> <span class="s">&#39;get_promotion&#39;</span><span class="p">,</span> <span class="s">&#39;set_promotion&#39;</span><span class="p">,</span> <span class="s">&#39;set_promotion_rule&#39;</span><span class="p">,</span>
    <span class="s">&#39;promote_type&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c"># In Python 2 we have to handle new style vs old style classes</span>
<span class="n">Type</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="nb">type</span><span class="p">])</span>
<span class="k">class</span> <span class="nc">_cls</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="n">Type</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">_cls</span><span class="p">)</span>
<span class="n">Type</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">Type</span><span class="p">)</span>


<span class="c">#</span>
<span class="c"># Define the convert() function and friends.</span>
<span class="c">#</span>
<span class="n">CONVERT_FUNCTIONS</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">_do_nothing</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A function that does nothing and returns its argument&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">x</span>


<div class="viewcode-block" id="convert"><a class="viewcode-back" href="../../conversion.html#generic.conversion.convert">[docs]</a><span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert value to the given type.</span>

<span class="sd">    It raises a TypeError if no conversion is possible and a ValueError if</span>
<span class="sd">    conversion is possible in general, but not for the specific value given.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; convert(42, float)</span>
<span class="sd">    42.0</span>
<span class="sd">    &gt;&gt;&gt; convert(&#39;42&#39;, float)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">    ...</span>
<span class="sd">    TypeError: cannot convert &#39;str&#39; to &#39;float&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">is</span> <span class="n">T</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="n">get_conversion</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">converter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">raise</span>

</div>
<div class="viewcode-block" id="get_conversion"><a class="viewcode-back" href="../../conversion.html#generic.conversion.get_conversion">[docs]</a><span class="k">def</span> <span class="nf">get_conversion</span><span class="p">(</span><span class="n">from_type</span><span class="p">,</span> <span class="n">to_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a function that converts from input type to the given output</span>
<span class="sd">    type&quot;&quot;&quot;</span>

    <span class="c"># Look up in dictionary</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CONVERT_FUNCTIONS</span><span class="p">[</span><span class="n">from_type</span><span class="p">,</span> <span class="n">to_type</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">to_type</span><span class="p">,</span> <span class="n">from_type</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">_do_nothing</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;not types: </span><span class="si">%r</span><span class="s">, </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">from_type</span><span class="p">,</span> <span class="n">to_type</span><span class="p">))</span>

    <span class="c"># Handle key error</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">from_type</span><span class="p">,</span> <span class="n">Type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_type</span><span class="p">,</span> <span class="n">Type</span><span class="p">)):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">Type</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">from_type</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">to_type</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;not types: </span><span class="si">%r</span><span class="s">, </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">from_type</span><span class="p">,</span> <span class="n">to_type</span><span class="p">))</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">from_type</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">to_type</span><span class="o">.</span><span class="n">__name__</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;cannot convert &#39;</span><span class="si">%s</span><span class="s">&#39; to &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">fmt</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="set_conversion"><a class="viewcode-back" href="../../conversion.html#generic.conversion.set_conversion">[docs]</a><span class="k">def</span> <span class="nf">set_conversion</span><span class="p">(</span><span class="n">from_type</span><span class="p">,</span> <span class="n">to_type</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register a function that converts between the two given types.</span>

<span class="sd">    Can be used as a decorator as in::</span>

<span class="sd">        @set_conversion(int, float)</span>
<span class="sd">        def int_to_float(x):</span>
<span class="sd">            return float(x)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Decorator form</span>
    <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="n">set_conversion</span><span class="p">(</span><span class="n">from_type</span><span class="p">,</span> <span class="n">to_type</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="c"># Forbid redefinitions</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">from_type</span><span class="p">,</span> <span class="n">to_type</span><span class="p">)</span> <span class="ow">in</span> <span class="n">CONVERT_FUNCTIONS</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">from_type</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">to_type</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;cannot overwrite convertion from </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fmt</span><span class="p">)</span>

    <span class="n">CONVERT_FUNCTIONS</span><span class="p">[</span><span class="n">from_type</span><span class="p">,</span> <span class="n">to_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span>


<span class="c">#</span>
<span class="c"># Define the promote() function and friends.</span>
<span class="c">#</span></div>
<span class="n">PROMOTION_FUNCTIONS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">PROMOTION_RULES</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="promote"><a class="viewcode-back" href="../../conversion.html#generic.conversion.promote">[docs]</a><span class="k">def</span> <span class="nf">promote</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Promote x and y to a common type.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; promote(1, 3.14)</span>
<span class="sd">    (1.0, 3.14)</span>
<span class="sd">    &gt;&gt;&gt; promote(1, 2, 3.0)</span>
<span class="sd">    (1.0, 2.0, 3.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_promote_values</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">x_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="c"># Fast track common types and patterns</span>
    <span class="k">if</span> <span class="n">x_type</span> <span class="ow">is</span> <span class="n">y_type</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x_type</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">and</span> <span class="n">y_type</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x_type</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">y_type</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span>

    <span class="c"># Generic track for all other types</span>
    <span class="n">promote_func</span> <span class="o">=</span> <span class="n">get_promotion</span><span class="p">(</span><span class="n">x_type</span><span class="p">,</span> <span class="n">y_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">promote_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">_promote_values</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a promotion of many elements to the most generic type</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; _promote_values(1, 2, 3.0)</span>
<span class="sd">    (1.0, 2.0, 3.0)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">elements</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="n">elements</span><span class="p">)]</span>

    <span class="c"># Go back and forth doing all promotions</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">promote</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">promote</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>


<div class="viewcode-block" id="get_promotion"><a class="viewcode-back" href="../../conversion.html#generic.conversion.get_promotion">[docs]</a><span class="k">def</span> <span class="nf">get_promotion</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a function f(x, y) that returns a tuple (X, Y) with the promoted</span>
<span class="sd">    versions of x and y. Both outputs X and Y have the same value.</span>

<span class="sd">    Raises a TypeError if no promotion function is found&quot;&quot;&quot;</span>

    <span class="c"># Check the promotions dictionary</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PROMOTION_FUNCTIONS</span><span class="p">[</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c"># Check if types are the same</span>
    <span class="k">if</span> <span class="n">T1</span> <span class="ow">is</span> <span class="n">T2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">T1</span>

    <span class="c"># Look for a promotion rule for a base type</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="n">PROMOTION_FUNCTIONS</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">T1</span><span class="o">.</span><span class="n">mro</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">tj</span> <span class="ow">in</span> <span class="n">T2</span><span class="o">.</span><span class="n">mro</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ti</span><span class="p">,</span> <span class="n">tj</span><span class="p">)</span> <span class="ow">in</span> <span class="n">rules</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tj</span><span class="p">,</span> <span class="n">ti</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid</span><span class="p">:</span>
                <span class="n">valid</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ti</span><span class="p">,</span> <span class="n">tj</span><span class="p">))</span>

    <span class="c"># No valid rules found</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
            <span class="c"># Try to convert to subtype</span>
            <span class="k">def</span> <span class="nf">promotion</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">convert</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">T1</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

            <span class="k">return</span> <span class="n">promotion</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">T1</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">get_promotion</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">T1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="n">T1</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">T2</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;no promotion rule found for </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">aux</span><span class="p">)</span>

    <span class="c"># More than one rule was found</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="p">(</span><span class="n">T1</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">T2</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;ambiguous promotion found for </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">aux</span><span class="p">)</span>

    <span class="c"># A single promotion was found</span>
    <span class="c"># TODO: cache it?</span>
    <span class="k">return</span> <span class="n">rules</span><span class="p">[</span><span class="n">valid</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

</div>
<div class="viewcode-block" id="set_promotion"><a class="viewcode-back" href="../../conversion.html#generic.conversion.set_promotion">[docs]</a><span class="k">def</span> <span class="nf">set_promotion</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                  <span class="n">function</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">symmetric</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">restype</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define the promotion rule for the pair of types (T1, T2).</span>

<span class="sd">    It is usually more convenient to use the set_promotion_rule() function.</span>
<span class="sd">    Otherwise the user must take care of the order of arguments and manual</span>
<span class="sd">    conversions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    T1,T2: type</span>
<span class="sd">        The two input types the promotion function relates to</span>
<span class="sd">    function : callable</span>
<span class="sd">        A function f(x, y) --&gt; (X, Y) that performs the promotion.</span>
<span class="sd">    symmetric : bool</span>
<span class="sd">        If True (default), the promotion is considered to be symmetric: i.e.,</span>
<span class="sd">        promotion for (T2, T1) is given calling f(y, x)</span>
<span class="sd">    restype : type</span>
<span class="sd">        Optional type of the promotion. It is considered to be a bad practice</span>
<span class="sd">        to define a promotion that may return a different type depending on the</span>
<span class="sd">        argument values. This optional parameters tells the expected output</span>
<span class="sd">        type for the given promotion. This information may be useful by other</span>
<span class="sd">        functions in order to make stronger assumptions about promotions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Decorator form</span>
    <span class="k">if</span> <span class="n">function</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="n">set_promotion</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">decorator</span>

    <span class="c"># Check if promotion is valid</span>
    <span class="k">if</span> <span class="n">T1</span> <span class="ow">is</span> <span class="n">T2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">ABCMeta</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;cannot set a promotion rule for identical contrete types.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">PROMOTION_FUNCTIONS</span> <span class="ow">or</span> <span class="p">(</span><span class="n">symmetric</span> <span class="ow">and</span> <span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">T1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">PROMOTION_FUNCTIONS</span><span class="p">):</span>
        <span class="n">out_name</span> <span class="o">=</span> <span class="n">restype</span><span class="o">.</span><span class="n">__name__</span> <span class="k">if</span> <span class="n">restype</span> <span class="k">else</span> <span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s">&#39;()&#39;</span><span class="p">)</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">T1</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">T2</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">out_name</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;cannot overwrite promotion rule: (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">) --&gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fmt</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">PROMOTION_FUNCTIONS</span><span class="p">[</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span>
    <span class="n">PROMOTION_RULES</span><span class="p">[</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">]</span> <span class="o">=</span> <span class="n">restype</span>
    <span class="k">if</span> <span class="n">symmetric</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">reverse_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
        <span class="n">PROMOTION_FUNCTIONS</span><span class="p">[</span><span class="n">T2</span><span class="p">,</span> <span class="n">T1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reverse_function</span>
        <span class="n">PROMOTION_RULES</span><span class="p">[</span><span class="n">T2</span><span class="p">,</span> <span class="n">T1</span><span class="p">]</span> <span class="o">=</span> <span class="n">restype</span>

</div>
<div class="viewcode-block" id="set_promotion_rule"><a class="viewcode-back" href="../../conversion.html#generic.conversion.set_promotion_rule">[docs]</a><span class="k">def</span> <span class="nf">set_promotion_rule</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the simple promotion rule for when the promotion from type T1 with</span>
<span class="sd">    type T2 is a simple convertion to type T3.</span>

<span class="sd">    Usually T3 is one of T1 or T2, but this is not necessary. The user does</span>
<span class="sd">    not have to specify the symmetric promotion (T2, T1) to T3.&quot;&quot;&quot;</span>

    <span class="c"># Check types</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">PROMOTION_FUNCTIONS</span> <span class="ow">or</span> <span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">T1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">PROMOTION_FUNCTIONS</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">T1</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">T2</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">T3</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s">&#39;cannot overwrite promotion rule: (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">) --&gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fmt</span><span class="p">)</span>

    <span class="c"># Check trivial promotion</span>
    <span class="k">if</span> <span class="n">T1</span> <span class="ow">is</span> <span class="n">T2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;cannot set a promotion rule for identical types.&#39;</span><span class="p">)</span>

    <span class="c"># Saves the direct promotion T1, T2 -&gt; T3</span>
    <span class="n">convert13</span> <span class="o">=</span> <span class="n">get_conversion</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T3</span><span class="p">)</span>
    <span class="n">convert23</span> <span class="o">=</span> <span class="n">get_conversion</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">T3</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">T1</span> <span class="ow">is</span> <span class="n">T3</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">promote_direct</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">convert23</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">promote_reverse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">convert23</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">T2</span> <span class="ow">is</span> <span class="n">T3</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">promote_direct</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">convert13</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">promote_reverse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">convert13</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">promote_direct</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">convert13</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">convert23</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">promote_reverse</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">convert13</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">convert23</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="n">PROMOTION_FUNCTIONS</span><span class="p">[</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">]</span> <span class="o">=</span> <span class="n">promote_direct</span>
    <span class="n">PROMOTION_FUNCTIONS</span><span class="p">[</span><span class="n">T2</span><span class="p">,</span> <span class="n">T1</span><span class="p">]</span> <span class="o">=</span> <span class="n">promote_reverse</span>
    <span class="n">PROMOTION_RULES</span><span class="p">[</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">]</span> <span class="o">=</span> <span class="n">T3</span>
    <span class="n">PROMOTION_RULES</span><span class="p">[</span><span class="n">T2</span><span class="p">,</span> <span class="n">T1</span><span class="p">]</span> <span class="o">=</span> <span class="n">T3</span>

</div>
<div class="viewcode-block" id="promote_type"><a class="viewcode-back" href="../../conversion.html#generic.conversion.promote_type">[docs]</a><span class="k">def</span> <span class="nf">promote_type</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the output type for the promotion rule with types T1 and T2&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">PROMOTION_RULES</span><span class="p">[</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">T2</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">T2</span><span class="p">,</span> <span class="n">T1</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">T1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="n">T1</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">T2</span><span class="o">.</span><span class="n">__name__</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;no promotion rule for (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">fmt</span><span class="p">)</span>


<span class="c">#</span>
<span class="c"># Conversion rules</span>
<span class="c">#</span></div>
<span class="n">set_conversion</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
<span class="n">set_conversion</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
<span class="n">set_conversion</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
<span class="n">set_conversion</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<span class="n">set_conversion</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
<span class="n">set_conversion</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>


<span class="nd">@set_conversion</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
<span class="nd">@set_conversion</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
<span class="nd">@set_conversion</span><span class="p">(</span><span class="nb">complex</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">number2bool</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InexactError</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="nd">@set_conversion</span><span class="p">(</span><span class="nb">complex</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<span class="nd">@set_conversion</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">number2int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InexactError</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c">#</span>

<span class="c"># Promotion rules</span>
<span class="c">#</span>
<span class="n">set_promotion_rule</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
<span class="n">set_promotion_rule</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
<span class="n">set_promotion_rule</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
<span class="n">set_promotion_rule</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<span class="n">set_promotion_rule</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
<span class="n">set_promotion_rule</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Fábio Macêdo Mendes.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
    </div>

    

    
  </body>
</html>